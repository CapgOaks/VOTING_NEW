<h2 class="fw-bold mt-0 mb-4 display-6">Instructor Management</h2>

<form id="instructorForm" class="mb-4" novalidate>
  <div class="mb-3">
    <label for="instructorName" class="form-label">Instructor Name</label>
    <input type="text" class="form-control" id="instructorName" required />
    <div class="invalid-feedback">At least 5 characters required.</div>
  </div>
  <div class="mb-3">
    <label for="expertise" class="form-label">Expertise</label>
    <input type="text" class="form-control" id="expertise" required />
    <div class="invalid-feedback">At least 5 characters required.</div>
  </div>
  <button type="submit" class="btn btn-success" id="submitBtn">
    Add Instructor
  </button>
</form>
<hr>
<table class="table table-bordered table-striped">
  <thead class="table-secondary">
    <tr>
      <th>Instructor Name <i class="bi bi-arrow-down-up"></i></th>
      <th>Expertise <i class="bi bi-arrow-down-up"></i></th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="instructorTableBody"></tbody>
</table>

<script>
  (() => {
    const apiUrl = "http://localhost:8080/api/instructor";
    const form = document.getElementById("instructorForm");
    const instructorNameInput = document.getElementById("instructorName");
    const expertiseInput = document.getElementById("expertise");
    const submitBtn = document.getElementById("submitBtn");
    const searchInput = document.createElement("input");

    let editId = null;
    let sortDirection = 1;

    let allInstructors = [];

    // Search bar setup
    searchInput.setAttribute("type", "text");
    searchInput.setAttribute("placeholder", "Search Details...");
    searchInput.classList.add("form-control", "mb-3");
    document
      .querySelector(".table")
      .parentNode.insertBefore(searchInput, document.querySelector(".table"));

    searchInput.addEventListener("input", () => {
      const searchTerm = searchInput.value.toLowerCase();
      const filtered = allInstructors.filter(
        (inst) =>
          inst.instructorName.toLowerCase().includes(searchTerm) |
          inst.expertise.toLowerCase().includes(searchTerm)
      );
      renderInstructors(filtered);
    });

    //Validate data
    function validateInstructorName() {
      if (instructorNameInput.value.trim().length >= 5) {
        instructorNameInput.classList.add("is-valid");
        instructorNameInput.classList.remove("is-invalid");
        return true;
      } else {
        instructorNameInput.classList.add("is-invalid");
        instructorNameInput.classList.remove("is-valid");
        return false;
      }
    }

    function validateExpertise() {
      if (expertiseInput.value.trim().length >= 5) {
        expertiseInput.classList.add("is-valid");
        expertiseInput.classList.remove("is-invalid");
        return true;
      } else {
        expertiseInput.classList.add("is-invalid");
        expertiseInput.classList.remove("is-valid");
        return false;
      }
    }

    instructorNameInput.addEventListener("blur", validateInstructorName);
    expertiseInput.addEventListener("blur", validateExpertise);


    function fetchAndRenderInstructors() {
      fetch(apiUrl, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": getAuthorization()
        },
      })
        .then((res) => res.json())
        .then((data) => {
          allInstructors = data;
          renderInstructors(data);
        });
    }
    function renderInstructors(instructors) {
      const tbody = document.getElementById("instructorTableBody");
      tbody.innerHTML = "";

      instructors.forEach((inst) => {
        const row = document.createElement("tr");
        row.innerHTML = `
               <td>${inst.instructorName}</td>
               <td>${inst.expertise}</td>
               <td>
                 <button class="btn btn-sm btn-outline-success me-1 edit-btn" data-id="${inst.id}">
                   <i class="bi bi-pencil-square"></i>
                 </button>
                 <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${inst.id}">
                   <i class="bi bi-trash"></i>
                 </button>
               </td>
               `;
        tbody.appendChild(row);

      });

      //edit-button
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          loadInstructorForEdit(id);
        });
      });

      //delete-button
      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          deleteInstructor(id);
        });
      });
    }

    function loadInstructorForEdit(id) {
      fetch(`${apiUrl}/${id}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": getAuthorization()
        },
      })
        .then((res) => res.json())
        .then((data) => {
          instructorNameInput.value = data.instructorName;
          expertiseInput.value = data.expertise;
          editId = id;
          submitBtn.textContent = "Update Instructor";
        });
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      if (!(validateExpertise() & validateInstructorName())) return;
      // const maxId = allUsers.reduce((max, instructor) => {
      //   return Math.max(max, parseInt(instructor.id));
      // }, 0);

      // const newId = (maxId + 1).toString();
      const instructor = {
        // id: newId,
        instructorName: instructorNameInput.value.trim(),
        expertise: expertiseInput.value.trim(),
      };

      if (editId) {
        fetch(`${apiUrl}/${editId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": getAuthorization()
          },
          body: JSON.stringify(instructor),
        }).then(() => {
          fetchAndRenderInstructors();
          form.reset();
          editId = null;
          submitBtn.textContent = "Add Instructor";
          clearValidation();
         
        });
      } else {
        fetch(apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": getAuthorization()
          },
          body: JSON.stringify(instructor),
        }).then(() => {
          fetchAndRenderInstructors();
          form.reset();
          clearValidation();
        });
      }
    });

    function clearValidation() {
      instructorNameInput.classList.remove("is-valid", "is-invalid");
      expertiseInput.classList.remove("is-valid", "is-invalid");
    }
    //delete instructor
    function deleteInstructor(id) {
      console.log(id);
      if (confirm("Are you sure you want to delete this instructor?")) {
        fetch(`${apiUrl}/${id}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            "Authorization": getAuthorization()
          }
        }).then(() => fetchAndRenderInstructors());
      }
    }

    // Sorting logic on Instructor Name
    document.querySelector("th:nth-child(1)").style.cursor = "pointer";
    document
      .querySelector("th:nth-child(1)")
      .addEventListener("click", () => {
        const sorted = [...allInstructors].sort(
          (a, b) =>
            a.instructorName.localeCompare(b.instructorName) * sortDirection
        );
        sortDirection *= -1;
        renderInstructors(sorted);
      });

    document.querySelector("th:nth-child(2)").style.cursor = "pointer";
    document
      .querySelector("th:nth-child(2)")
      .addEventListener("click", () => {
        const sorted = [...allInstructors].sort(
          (a, b) => a.expertise.localeCompare(b.expertise) * sortDirection
        );
        sortDirection *= -1;
        renderInstructors(sorted);
      });
    fetchAndRenderInstructors();
  })();
</script>